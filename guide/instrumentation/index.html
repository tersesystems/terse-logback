



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
    
    
      
        <title>Bytecode Instrumentation - terse-logback</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#instrumentation" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="terse-logback" aria-label="terse-logback" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              terse-logback
            </span>
            <span class="md-header-nav__topic">
              
                Bytecode Instrumentation
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/tersesystems/terse-logback/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    terse-logback
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="terse-logback" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    terse-logback
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/tersesystems/terse-logback/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    terse-logback
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../structured-logging/" title="Structured Logging" class="md-nav__link">
      Structured Logging
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      User guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        User guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../audio/" title="Audio" class="md-nav__link">
      Audio
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../budget/" title="Budgeting" class="md-nav__link">
      Budgeting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../censor/" title="Censors" class="md-nav__link">
      Censors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../compression/" title="Compression" class="md-nav__link">
      Compression
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../correlationid/" title="Correlation Id" class="md-nav__link">
      Correlation Id
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exception-mapping/" title="Exception Mapping" class="md-nav__link">
      Exception Mapping
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Bytecode Instrumentation
      </label>
    
    <a href="./" title="Bytecode Instrumentation" class="md-nav__link md-nav__link--active">
      Bytecode Instrumentation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instrumenting-application-code" class="md-nav__link">
    Instrumenting Application Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumenting-system-classes" class="md-nav__link">
    Instrumenting System Classes
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jdbc/" title="JDBC" class="md-nav__link">
      JDBC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ringbuffer/" title="Ring Buffers" class="md-nav__link">
      Ring Buffers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../systeminfo/" title="System Info" class="md-nav__link">
      System Info
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tapfilter/" title="Tap Filters" class="md-nav__link">
      Tap Filters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tracing/" title="Tracing with Honeycomb" class="md-nav__link">
      Tracing with Honeycomb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../config/" title="Typesafe Config" class="md-nav__link">
      Typesafe Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../turbomarker/" title="Targeted Logging with Turbo Marker" class="md-nav__link">
      Targeted Logging with Turbo Marker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../uniqueid/" title="Unique ID Appenders" class="md-nav__link">
      Unique ID Appenders
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../structured-config/" title="Structured Config" class="md-nav__link">
      Structured Config
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../release-notes/" title="Release notes" class="md-nav__link">
      Release notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../reading/" title="Further Reading" class="md-nav__link">
      Further Reading
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instrumenting-application-code" class="md-nav__link">
    Instrumenting Application Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumenting-system-classes" class="md-nav__link">
    Instrumenting System Classes
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/tersesystems/terse-logback/edit/master/guide/src/doc/docs/guide/instrumentation.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="instrumentation">Instrumentation<a class="headerlink" href="#instrumentation" title="Permanent link">&para;</a></h1>
<p>If you have library code that doesn't pass around <code>ILoggerFactory</code> and doesn't let you add information to logging, then you can get around this by instrumenting the code with <a href="https://bytebuddy.net/">Byte Buddy</a>.  Using Byte Buddy, you can do fun things like override <code>Security.setSystemManager</code> with <a href="https://tersesystems.com/blog/2016/01/19/redefining-java-dot-lang-dot-system/">your own implementation</a>, so using Byte Buddy to decorate code with <code>enter</code> and <code>exit</code> logging statements is relatively straightforward.</p>
<p>I like this approach better than the annotation or aspect-oriented programming approaches, because it is completely transparent to the code and gives roughly the same performance as inline code, adding <a href="https://github.com/raphw/byte-buddy/issues/714">130 ns/op</a> by calling <code>class.getMethod</code>.</p>
<p>There are two ways you can instrument code.  The first way is to do it in process, after the JVM has loaded.  The second way is to load the java agent before the JVM starts, which lets you instrument classes on the system classloader.</p>
<h3 id="instrumenting-application-code">Instrumenting Application Code<a class="headerlink" href="#instrumenting-application-code" title="Permanent link">&para;</a></h3>
<p>The in process instrumentation is done with <code>com.tersesystems.logback.bytebuddy.LoggingInstrumentationByteBuddyBuilder</code>, which takes in some configuration and then installs itself on the byte buddy agent.</p>
<div class="codehilite"><pre><span></span><code><span class="k">new</span> <span class="n">LoggingInstrumentationByteBuddyBuilder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">builderFromConfig</span><span class="p">(</span><span class="n">loggingInstrumentationAdviceConfig</span><span class="p">)</span>
        <span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">debugListener</span><span class="p">)</span>
        <span class="p">.</span><span class="na">installOnByteBuddyAgent</span><span class="p">();</span>
</code></pre></div>

<p>This is driven from configuration, so with the following code:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassCalledByAgent</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printStatement</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;I am a simple println method with no logging&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printArgument</span><span class="p">(</span><span class="n">String</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;I am a simple println, printing &quot;</span> <span class="o">+</span> <span class="n">arg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">throwException</span><span class="p">(</span><span class="n">String</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;I&#39;m a squirrel!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>And the following configuration in <code>logback.conf</code>:</p>
<div class="codehilite"><pre><span></span><code>logback.bytebuddy {
  service-name = &quot;example-service&quot;
  tracing {
    &quot;com.tersesystems.logback.bytebuddy.ClassCalledByAgent&quot; = [
      &quot;printStatement&quot;,
      &quot;printArgument&quot;,
      &quot;throwException&quot;,
    ]
  }
}
</code></pre></div>

<p>and have <code>com.tersesystems.logback.bytebuddy.ClassCalledByAgent</code> logging level set to <code>TRACE</code> in <code>logback.xml</code>.</p>
<p>We can start up the agent, add in the builder and run through the methods:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InProcessInstrumentationExample</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AgentBuilder</span><span class="p">.</span><span class="na">Listener</span> <span class="nf">createDebugListener</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">classNames</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">AgentBuilder</span><span class="p">.</span><span class="na">Listener</span><span class="p">.</span><span class="na">Filtering</span><span class="p">(</span>
                <span class="n">LoggingInstrumentationAdvice</span><span class="p">.</span><span class="na">stringMatcher</span><span class="p">(</span><span class="n">classNames</span><span class="p">),</span>
                <span class="n">AgentBuilder</span><span class="p">.</span><span class="na">Listener</span><span class="p">.</span><span class="na">StreamWriting</span><span class="p">.</span><span class="na">toSystemOut</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">// Helps if you install the byte buddy agents before anything else at all happens...</span>
        <span class="n">ByteBuddyAgent</span><span class="p">.</span><span class="na">install</span><span class="p">();</span>

        <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">InProcessInstrumentationExample</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">SystemFlow</span><span class="p">.</span><span class="na">setLoggerResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">FixedLoggerResolver</span><span class="p">(</span><span class="n">logger</span><span class="p">));</span>

        <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="n">LoggingInstrumentationAdvice</span><span class="p">.</span><span class="na">generateConfig</span><span class="p">(</span><span class="n">ClassLoader</span><span class="p">.</span><span class="na">getSystemClassLoader</span><span class="p">(),</span> <span class="kc">false</span><span class="p">);</span>
        <span class="n">LoggingInstrumentationAdviceConfig</span> <span class="n">adviceConfig</span> <span class="o">=</span> <span class="n">LoggingInstrumentationAdvice</span><span class="p">.</span><span class="na">generateAdviceConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

        <span class="c1">// The debugging listener shows what classes are being picked up by the instrumentation</span>
        <span class="n">Listener</span> <span class="n">debugListener</span> <span class="o">=</span> <span class="n">createDebugListener</span><span class="p">(</span><span class="n">adviceConfig</span><span class="p">.</span><span class="na">classNames</span><span class="p">());</span>
        <span class="k">new</span> <span class="n">LoggingInstrumentationByteBuddyBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="na">builderFromConfig</span><span class="p">(</span><span class="n">adviceConfig</span><span class="p">)</span>
                <span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">debugListener</span><span class="p">)</span>
                <span class="p">.</span><span class="na">installOnByteBuddyAgent</span><span class="p">();</span>

        <span class="c1">// No code change necessary here, you can wrap completely in the agent...</span>
        <span class="n">ClassCalledByAgent</span> <span class="n">classCalledByAgent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassCalledByAgent</span><span class="p">();</span>
        <span class="n">classCalledByAgent</span><span class="p">.</span><span class="na">printStatement</span><span class="p">();</span>
        <span class="n">classCalledByAgent</span><span class="p">.</span><span class="na">printArgument</span><span class="p">(</span><span class="s">&quot;42&quot;</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="n">classCalledByAgent</span><span class="p">.</span><span class="na">throwException</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// I am too lazy to catch this exception.  I hope someone does it for me.</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>And get the following:</p>
<div class="codehilite"><pre><span></span><code>[Byte Buddy] DISCOVERY com.tersesystems.logback.bytebuddy.ClassCalledByAgent [sun.misc.Launcher$AppClassLoader@75b84c92, null, loaded=true]
[Byte Buddy] TRANSFORM com.tersesystems.logback.bytebuddy.ClassCalledByAgent [sun.misc.Launcher$AppClassLoader@75b84c92, null, loaded=true]
[Byte Buddy] COMPLETE com.tersesystems.logback.bytebuddy.ClassCalledByAgent [sun.misc.Launcher$AppClassLoader@75b84c92, null, loaded=true]
524   TRACE c.t.l.b.InProcessInstrumentationExample - entering: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.printStatement() with arguments=[] from source ClassCalledByAgent.java:18
I am a simple println method with no logging
529   TRACE c.t.l.b.InProcessInstrumentationExample - exiting: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.printStatement() with arguments=[] =&gt; returnType=void from source ClassCalledByAgent.java:19
529   TRACE c.t.l.b.InProcessInstrumentationExample - entering: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.printArgument(java.lang.String) with arguments=[42] from source ClassCalledByAgent.java:22
I am a simple println, printing 42
529   TRACE c.t.l.b.InProcessInstrumentationExample - exiting: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.printArgument(java.lang.String) with arguments=[42] =&gt; returnType=void from source ClassCalledByAgent.java:23
529   TRACE c.t.l.b.InProcessInstrumentationExample - entering: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.throwException(java.lang.String) with arguments=[hello world] from source ClassCalledByAgent.java:26
532   ERROR c.t.l.b.InProcessInstrumentationExample - throwing: com.tersesystems.logback.bytebuddy.ClassCalledByAgent.throwException(java.lang.String) with arguments=[hello world] ! thrown=java.lang.RuntimeException: I&#39;m a squirrel!
java.lang.RuntimeException: I&#39;m a squirrel!
    at com.tersesystems.logback.bytebuddy.ClassCalledByAgent.throwException(ClassCalledByAgent.java:26)
    at com.tersesystems.logback.bytebuddy.InProcessInstrumentationExample.main(InProcessInstrumentationExample.java:65)
</code></pre></div>

<p>The <code>[Byte Buddy]</code> statements up top are caused by the debug listener, and let you know that Byte Buddy has successfully instrumented the class.  Note also that there is no runtime overhead in pulling line numbers or source files into the enter/exit methods, as these are pulled directly from bytecode and do not involve <code>fillInStackTrace</code>.</p>
<p>If you want to trace all the methods in a class, you can use a wildcard, i.e. <code>"mypackage.MyClass" = ["*"]</code>.</p>
<p>If you are using <code>logback-typesafe-config</code> then you can also set the levels from <code>logback.conf</code>, which can be very convenient.  For example in a Play application, you could set:</p>
<div class="codehilite"><pre><span></span><code>levels {
  controllers = TRACE
  services = TRACE
  models = TRACE
  play.api.mvc = TRACE
}

logback.bytebuddy {
  service-name = &quot;play-hello-world&quot;

  tracing {
    &quot;play.api.mvc.ActionBuilder&quot; = [&quot;*&quot;]
    &quot;play.api.mvc.BodyParser&quot; = [&quot;*&quot;]
    &quot;play.api.mvc.ActionFunction&quot; = [&quot;*&quot;]

    &quot;services.ComputerService&quot; = [&quot;*&quot;]
    &quot;controllers.HomeController&quot; = [&quot;*&quot;]
    &quot;models.Computer&quot; = [&quot;*&quot;]
  }
}
</code></pre></div>

<p>and get automatic tracing.  This works particularly well with the honeycomb appender.</p>
<h3 id="instrumenting-system-classes">Instrumenting System Classes<a class="headerlink" href="#instrumenting-system-classes" title="Permanent link">&para;</a></h3>
<p>Instrumenting system level classes is a bit more involved, but can be done in configuration.</p>
<blockquote>
<p><strong>NOTE</strong>: There are some limitations to instrumenting system level code.  You cannot instrument native methods like <code>java.lang.System.currentTimeMillis()</code> for example.</p>
</blockquote>
<p>First, you set the java agent, either directly on the command line:</p>
<div class="codehilite"><pre><span></span><code>java <span class="se">\</span>
  -javaagent:path/to/logback-bytebuddy-x.x.x.jar<span class="o">=</span>debug <span class="se">\</span>
  -Dterse.logback.configurationFile<span class="o">=</span>conf/logback.conf <span class="se">\</span>
  -Dlogback.configurationFile<span class="o">=</span>conf/logback-test.xml <span class="se">\</span>
  com.example.PreloadedInstrumentationExample
</code></pre></div>

<p>or by using the <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/envvars002.html"><code>JAVA_TOOLS_OPTIONS</code> environment variable</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="nb">export</span> <span class="nv">JAVA_TOOLS_OPTIONS</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>
</code></pre></div>

<p>and then in <code>logback.conf</code>:</p>
<div class="codehilite"><pre><span></span><code>levels {
  java.lang.Thread = TRACE
}

logback.bytebuddy {
  service-name = &quot;some-service&quot;
  tracing {
    &quot;java.lang.Thread&quot; = [
      &quot;run&quot;
    ]
  }
}
</code></pre></div>

<p>and the code as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PreloadedInstrumentationExample</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span>
        <span class="n">thread</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>yields</p>
<div class="codehilite"><pre><span></span><code>[Byte Buddy] DISCOVERY java.lang.Thread [null, null, loaded=true]
[Byte Buddy] TRANSFORM java.lang.Thread [null, null, loaded=true]
[Byte Buddy] COMPLETE java.lang.Thread [null, null, loaded=true]
92    TRACE java.lang.Thread - entering: java.lang.Thread.run() with arguments=[]
93    TRACE java.lang.Thread - exiting: java.lang.Thread.run() with arguments=[] =&gt; returnType=void
</code></pre></div>

<p>This is especially helpful when you're trying to debug SSL issues:</p>
<div class="codehilite"><pre><span></span><code>levels {
  sun.security.ssl = TRACE
  javax.net.ssl = TRACE
}

logback.bytebuddy {
  service-name = &quot;some-service&quot;
  tracing {  
    &quot;javax.net.ssl.SSLContext&quot; = [&quot;*&quot;]
  }
}
</code></pre></div>

<p>will result in:</p>
<div class="codehilite"><pre><span></span><code>FcJ3XfsdKnM6O0Qbm7EAAA 12:31:55.498 [TRACE] j.n.s.SSLContext -  entering: javax.net.ssl.SSLContext.getInstance(java.lang.String) with arguments=[TLS] from source SSLContext.java:155
FcJ3XfsdKng6O0Qbm7EAAA 12:31:55.503 [TRACE] j.n.s.SSLContext -  exiting: javax.net.ssl.SSLContext.getInstance(java.lang.String) with arguments=[TLS] =&gt; returnType=javax.net.ssl.SSLContext from source SSLContext.java:157
FcJ3XfsdKng6O0Qbm7EAAB 12:31:55.504 [TRACE] j.n.s.SSLContext -  entering: javax.net.ssl.SSLContext.init([Ljavax.net.ssl.KeyManager;,[Ljavax.net.ssl.TrustManager;,java.security.SecureRandom) with arguments=[[org.postgresql.ssl.LazyKeyManager@27a97e08], [org.postgresql.ssl.NonValidatingFactory$NonValidatingTM@5918c260], null] from source SSLContext.java:282
FcJ3XfsdKnk6O0Qbm7EAAA 12:31:55.504 [TRACE] j.n.s.SSLContext -  exiting: javax.net.ssl.SSLContext.init([Ljavax.net.ssl.KeyManager;,[Ljavax.net.ssl.TrustManager;,java.security.SecureRandom) with arguments=[[org.postgresql.ssl.LazyKeyManager@27a97e08], [org.postgresql.ssl.NonValidatingFactory$NonValidatingTM@5918c260], null] =&gt; returnType=void from source SSLContext.java:283
</code></pre></div>

<p>Be warned that JSSE can be extremely verbose in its <code>toString</code> output.</p>
<p>See <a href="https://tersesystems.com/blog/2019/06/11/application-logging-in-java-part-8/">Application Logging in Java: Tracing 3<sup>rd</sup> Party Code</a> and <a href="https://tersesystems.com/blog/2019/09/15/hierarchical-instrumented-tracing-with-logback/">Hierarchical Instrumented Tracing with Logback</a> for more details.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../exception-mapping/" title="Exception Mapping" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Exception Mapping
              </span>
            </div>
          </a>
        
        
          <a href="../jdbc/" title="JDBC" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                JDBC
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>